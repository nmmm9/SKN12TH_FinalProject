# 🚀 DdalKkak 빠른 시작 가이드

DdalKkak Multi-tenant SaaS 개발 환경을 빠르게 설정하고 실행하는 방법을 안내합니다.

## 📋 시스템 요구사항

### 필수 소프트웨어
- **Node.js**: 18.0.0 이상
- **Python**: 3.11 이상
- **PostgreSQL**: 15 이상
- **Redis**: 7 이상
- **Git**: 최신 버전

### 권장 사양
- **메모리**: 8GB 이상
- **저장공간**: 10GB 이상 여유공간
- **OS**: Windows 10/11, macOS 12+, Ubuntu 20.04+

---

## ⚡ 빠른 설치 (자동)

### Windows (PowerShell)
```powershell
# 저장소 클론
git clone https://github.com/your-org/ddalkkak.git
cd ddalkkak

# 자동 설치 스크립트 실행
.\scripts\setup.bat
```

### macOS/Linux (Bash)
```bash
# 저장소 클론
git clone https://github.com/your-org/ddalkkak.git
cd ddalkkak

# 자동 설치 스크립트 실행
chmod +x scripts/setup.sh
./scripts/setup.sh
```

---

## 🔧 수동 설치

### 1단계: 저장소 클론
```bash
git clone https://github.com/your-org/ddalkkak.git
cd ddalkkak
```

### 2단계: 환경 변수 설정 ⭐ **중요 변경사항**
```bash
# 환경 변수 파일 복사
cp .env.example .env

# 환경 변수 편집 (OAuth 설정 필요)
nano .env  # 또는 원하는 에디터 사용
```

**🚨 Multi-tenant 전환으로 설정 방식이 변경되었습니다:**
- ❌ **이전**: 개인 토큰을 .env에 직접 입력
- ✅ **현재**: OAuth 애플리케이션 생성 후 Client ID/Secret 설정

**📖 자세한 설정 방법은 `OAuth_설정_가이드.md` 참조**

### 3단계: 의존성 설치
```bash
# 루트 프로젝트 의존성 설치
npm install

# 모든 하위 프로젝트 의존성 설치
npm run install:all
```

### 4단계: 데이터베이스 설정
```bash
# PostgreSQL 및 Redis 서비스 시작
# Windows (서비스 관리자에서 시작)
# macOS: brew services start postgresql redis
# Ubuntu: sudo systemctl start postgresql redis-server

# Prisma 데이터베이스 마이그레이션 (Multi-tenant 스키마 적용)
cd backend
npx prisma migrate dev --name init-multitenant
npx prisma generate
cd ..
```

### 5단계: 환경 변수 검증
```bash
# 개발 서버 실행 전 환경 변수 검증
npm run dev:backend

# 환경 변수가 올바르지 않으면 친절한 가이드 메시지 출력
# 모든 설정이 완료되면 서버가 정상 시작됩니다
```

### 6단계: 개발 서버 실행
```bash
# 모든 서비스 동시 실행
npm run dev

# 또는 개별 실행
npm run dev:backend    # 백엔드 서버 (포트 3500)
npm run dev:ai         # AI 엔진 (포트 8001)
npm run dev:frontend   # 프론트엔드 (포트 3001)
```

---

## 🔑 환경 변수 설정 가이드 (Multi-tenant)

### ⚠️ 중요: OAuth 애플리케이션 설정 필요

이제 **개인 토큰 대신 OAuth 애플리케이션**을 설정해야 합니다:

```env
# ❌ 이전 방식 (더 이상 사용 안함)
SLACK_BOT_TOKEN=xoxb-개인토큰
NOTION_TOKEN=ntn_개인토큰

# ✅ 새로운 방식 (OAuth App)
SLACK_CLIENT_ID=1234567890.1234567890
SLACK_CLIENT_SECRET=실제_클라이언트_시크릿
NOTION_CLIENT_ID=실제_노션_클라이언트_ID
NOTION_CLIENT_SECRET=secret_실제_노션_시크릿
```

### 📋 OAuth 애플리케이션 생성 순서

1. **Slack OAuth App 생성**
   - 위치: https://api.slack.com/apps
   - Redirect URL: `http://localhost:3500/auth/slack/callback`

2. **Notion OAuth App 생성**
   - 위치: https://developers.notion.com/
   - Redirect URL: `http://localhost:3500/auth/notion/callback`

3. **Jira OAuth App 생성**
   - 위치: https://developer.atlassian.com/console/myapps/
   - Redirect URL: `http://localhost:3500/auth/jira/callback`

4. **Google OAuth App 생성**
   - 위치: https://console.cloud.google.com/
   - Redirect URL: `http://localhost:3500/auth/google/callback`

**📖 단계별 상세 가이드: `OAuth_설정_가이드.md` 파일 참조**

### 🔒 필수 보안 설정

```env
# 강력한 암호화 키 생성 (32바이트 hex)
ENCRYPTION_KEY=$(openssl rand -hex 32)

# JWT 시크릿 강화
JWT_SECRET=your_super_secret_jwt_key_production_12345

# 앱 URL 설정
APP_URL=http://localhost:3500  # 개발용
# APP_URL=https://yourdomain.com  # 프로덕션용
```

---

## ✅ 설치 확인

### 환경 변수 검증
서버 시작 시 자동으로 환경 변수를 검증합니다:

```bash
npm run dev:backend

# 출력 예시:
🔍 환경 변수 검증 결과

✅ 모든 환경 변수가 올바르게 설정되었습니다!

🔗 OAuth 콜백 URL:
  ✅ slack: http://localhost:3500/auth/slack/callback
  ✅ notion: http://localhost:3500/auth/notion/callback
  ✅ jira: http://localhost:3500/auth/jira/callback
  ✅ google: http://localhost:3500/auth/google/callback
```

### 서버 상태 확인
```bash
# 백엔드 서버 헬스체크
curl http://localhost:3500/health

# AI 엔진 헬스체크
curl http://localhost:8001/health

# 응답 예시
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "uptime": 123.45
}
```

### Multi-tenant 기능 테스트
```bash
# OAuth 연동 URL 생성 테스트
curl http://localhost:3500/auth/notion/url

# 응답 예시:
{
  "authUrl": "https://api.notion.com/v1/oauth/authorize?client_id=...",
  "state": "tenant123:user456:1234567890"
}
```

---

## 📱 Slack 앱 테스트 (Multi-tenant)

### 1. Slack OAuth App 설치
1. [Slack API 콘솔](https://api.slack.com/apps)에서 앱 설정
2. **OAuth & Permissions** → **Install to Workspace**
3. 권한 승인 후 앱 설치 완료

### 2. 테넌트별 연동 테스트
각 Slack 워크스페이스마다 독립적으로 작동:

```
# 회사 A Slack에서
/ddal-connect notion  → 회사 A Notion 연동

# 회사 B Slack에서  
/ddal-connect notion  → 회사 B Notion 연동 (완전 격리)
```

### 3. 기본 명령어 테스트
```
# 도움말 확인
/ddal-help

# 회의 시작 (테넌트별 격리)
/ddal-meeting start "프로젝트 기획 회의"

# 서비스 연동 상태 확인
/ddal-status

# 노션 연동
/ddal-connect notion
```

---

## 🔧 문제 해결

### Multi-tenant 관련 문제

#### 1. OAuth 설정 오류
```bash
# 환경 변수 검증으로 문제 확인
npm run dev:backend

# 일반적인 오류:
❌ SLACK_CLIENT_ID: 실제 값으로 교체 필요 (현재: YOUR-SLACK-CLIENT-ID-HERE)
❌ ENCRYPTION_KEY: 형식이 올바르지 않음 (64자 hex 필요)
```

#### 2. 콜백 URL 불일치
```
OAuth Error: redirect_uri_mismatch

해결: OAuth 앱 설정에서 Redirect URL 확인
- 설정값: http://localhost:3500/auth/slack/callback
- .env APP_URL: http://localhost:3500
```

#### 3. 테넌트 격리 확인
```bash
# 데이터베이스에서 테넌트 확인
psql -U postgres -d ddalkkak
SELECT * FROM tenants;
SELECT * FROM users WHERE tenant_id = 'specific-tenant-id';
```

### 일반적인 문제들

#### 데이터베이스 마이그레이션 실패
```bash
# Prisma 캐시 클리어
cd backend
npx prisma generate --force
npx prisma migrate reset --force
npx prisma migrate dev --name init-multitenant
```

#### 포트 충돌 오류
```bash
# 포트 사용 프로세스 확인
lsof -i :3500  # macOS/Linux
netstat -ano | findstr :3500  # Windows

# 프로세스 종료 후 재시작
```

---

## 🚀 다음 단계

### 1. OAuth 설정 완료 후
- **`OAuth_설정_가이드.md`** 으로 모든 서비스 연동 완료
- 각 서비스별 테스트 계정으로 연동 확인

### 2. Multi-tenant 테스트
- 여러 Slack 워크스페이스에서 동시 사용 테스트
- 데이터 격리 확인 (회사별 독립성)

### 3. 프로덕션 배포 준비
- HTTPS 도메인 설정
- OAuth 앱의 Redirect URL을 프로덕션 URL로 변경
- 환경 변수를 프로덕션용으로 업데이트

---

## 📁 주요 파일 위치

```
C:\Users\Playdata\Desktop\TtalKkak\
├── 📄 .env                          # 🔥 환경 변수 (OAuth 설정 필요)
├── 📄 .env.example                  # 환경 변수 템플릿
├── 📄 OAuth_설정_가이드.md           # OAuth 앱 생성 가이드
├── 📁 backend/
│   ├── 📄 prisma/schema.prisma      # Multi-tenant 데이터베이스 스키마
│   ├── 📁 src/
│   │   ├── 📄 index.ts              # 메인 서버 (환경 변수 검증 포함)
│   │   ├── 📁 middleware/
│   │   │   ├── 📄 tenant.ts         # Multi-tenant 미들웨어
│   │   │   └── 📄 auth.ts           # 인증 미들웨어
│   │   ├── 📁 services/
│   │   │   └── 📄 oauth.ts          # OAuth 서비스
│   │   ├── 📁 types/
│   │   │   └── 📄 tenant.ts         # Multi-tenant 타입 정의
│   │   └── 📁 utils/
│   │       └── 📄 envValidator.ts   # 환경 변수 검증
└── 📁 ai-engine/
    └── 📄 main.py                   # AI 서버 (Multi-tenant 지원)
```

---

## 📞 지원

문제가 발생하거나 도움이 필요하면:

- 📖 **OAuth 설정**: `OAuth_설정_가이드.md` 참조
- 🔧 **환경 변수**: `.env.example` 파일 참조
- 📝 **GitHub Issues**: [이슈 등록](https://github.com/your-org/ddalkkak/issues)
- 📧 **이메일**: support@ddalkkak.com

---

## 🆕 Multi-tenant 주요 변경사항 요약

| 항목 | 이전 (Single-tenant) | 현재 (Multi-tenant) |
|------|---------------------|-------------------|
| **토큰 관리** | .env에 개인 토큰 | OAuth App + 암호화 저장 |
| **사용자 격리** | 단일 계정 공유 | 회사별 완전 격리 |
| **설정 방법** | 개발자가 토큰 직접 입력 | OAuth App 생성 + Client ID/Secret |
| **보안 수준** | 낮음 | 높음 (암호화 + 격리) |
| **확장성** | 제한적 | 무제한 회사 지원 |

**🎉 이제 진짜 상용 SaaS 서비스로 시작할 수 있습니다!**